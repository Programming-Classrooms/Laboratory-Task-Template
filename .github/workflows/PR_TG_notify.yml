name: Notify programming GH chat
on:
  pull_request:
    types:
      - opened
      - synchronize
      - closed
      - reopened
    branches:
      - main

jobs:
  telegram-notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
          
      - name: Get commits
        id: get-commits
        run: |
          commit_count=${{ github.event.pull_request.commits }}
          echo "Number of commits: $commit_count"
          
          echo "REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)" >> $GITHUB_ENV
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$(git log origin/${{ github.head_ref }} --not origin/${{ github.base_ref }} --oneline --pretty=format:"%B" | grep -v '^$' | tac | nl -w 1 -s ' ' | sed 's/^/*/; s/ /.* /')" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Get branches names
        id: get-branches-names
        run: |
          echo "BASE_BRANCH_NAME=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          echo "HEAD_BRANCH_NAME=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          echo "BASE_BRANCH_LINK=https://github.com/${{ github.repository }}/tree/${{ github.base_ref }}" >> $GITHUB_OUTPUT
          echo "HEAD_BRANCH_LINK=https://github.com/${{ github.repository }}/tree/${{ github.head_ref }}" >> $GITHUB_OUTPUT

      - name: Get PR type
        id: get-pr-type
        run: |
          echo "PR_TYPE=${{ github.event.action }}" >> $GITHUB_OUTPUT
          
      - name: PR opened TG notify
        if: steps.get-pr-type.outputs.PR_TYPE == 'opened'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ github.actor }} *c–¥–µ–ª–∞–ª Pull Request!* üöÄ
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
            
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})
            
            üìå *–ö–æ–º–º–∏—Ç—ã:* 
            ${{ env.COMMITS }}
            
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }}) 

      - name: PR synchronized TG notify
        if: steps.get-pr-type.outputs.PR_TYPE == 'synchronize'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown 
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ github.actor }} *–¥–æ–±–∞–≤–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Pull Request!* üõ†Ô∏è
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
             
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})
             
            üìå *–ö–æ–º–º–∏—Ç—ã:*  
            ${{ env.COMMITS }}
              
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }}) 

      - name: Get commits if merged
        if: steps.get-pr-type.outputs.PR_TYPE == 'closed' && github.event.pull_request.merged == true
        id: get-commits-if-merged
        run: |
          echo "COMMITS_IF_MERGED<<EOF" >> $GITHUB_ENV
          echo "$(git log ${{ github.event.pull_request.merge_commit_sha }} --not origin/${{ github.base_ref }}~1 --oneline --pretty=format:"%B" | grep -v '^$' | tac | head -n -1 | nl -w 1 -s ' ' | sed 's/^/*/; s/ /.* /')" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
  
      - name: PR merged TG notify
        if: steps.get-pr-type.outputs.PR_TYPE == 'closed' && github.event.pull_request.merged == true
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ github.event.pull_request.merged_by.login }} *–≤–º–µ—Ä–∂–∏–ª Pull Request!* üéØ
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
            
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})
            
            üìå *–ö–æ–º–º–∏—Ç—ã:* 
            ${{ env.COMMITS_IF_MERGED }}
            
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }}) 

      - name: PR declined TG notify
        if: steps.get-pr-type.outputs.PR_TYPE == 'closed' && github.event.pull_request.merged == false
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ github.event.pull_request.user.login }}, *—Ç–≤–æ–π Pull Request –∑–∞–∫—Ä—ã—Ç –±–µ–∑ —Å–ª–∏—è–Ω–∏—è –≤–µ—Ç–æ–∫* üö´
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
            
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})

            üîí *–ó–∞–∫—Ä—ã–ª:* @${{ github.actor }}
            
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }}) 


      - name: PR reopened TG notify
        if: steps.get-pr-type.outputs.PR_TYPE == 'reopened'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TO }}
          token: ${{ secrets.TELEGRAM_PROGRAMMINGBOT_TOKEN }}
          format: markdown
          message: | #https://help.github.com/en/actions/reference/contexts-and-expression-syntax-for-github-actions#github-context
            @${{ github.event.pull_request.user.login }}, *—Ç–≤–æ–π Pull Request —Å–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã—Ç!* üïäÔ∏è
            
            üíª *–ü—Ä–æ–µ–∫—Ç:*  ${{ env.REPO_NAME }}

            üè∑Ô∏è *–ò–º—è PR:* ${{ github.event.pull_request.title }}
            
            üåø *–í–µ—Ç–∫–∏:*  [${{ steps.get-branches-names.outputs.BASE_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.BASE_BRANCH_LINK }}) <-- [${{ steps.get-branches-names.outputs.HEAD_BRANCH_NAME }}](${{ steps.get-branches-names.outputs.HEAD_BRANCH_LINK }})

            üîì *–û—Ç–∫—Ä—ã–ª:* @${{ github.actor }}
            
            üîó *–°—Å—ã–ª–∫–∞:*  [—Ç—ã–∫—Å—é–¥–∞](${{ github.event.pull_request.html_url }})
        
